#summary 矩形波の入ったWAVファイルを出力するツールSqWave2
#labels Featured


= 説明 =

!SqWave2は矩形波の入ったWAVファイルを出力するツールです。

!WaveGene 1.40の矩形波出力波形に納得いかない感じだったので作りました。

= 使用方法 =

http://bitspersampleconv2.googlecode.com/files/SqWave10009.zip
をダウンロードして、中に入っているsetup.exeを実行するとインストールされます。

デスクトップに!SqWave2という名前のショートカットが作られますのでこれをダブルクリックします。あとは画面の指示に従ってWAVファイルを出力します。

アンインストールは、コントロールパネルの[プログラムと機能]から!SqWave2を選んでアンインストールを選択するとできます。

http://bitspersampleconv2.googlecode.com/files/SqWave10008ss.png

CTRLキーを押しながら出力チャンネルを選択すると
出力チャンネルを複数選択できます。

==ASIO出力動作確認デバイス==

ASIO出力モードは、すべての環境で安定動作するところまでには至っていません。

以下のASIOデバイスでは動作しました。
 * M-AUDIO !ProFire 2626
 * Creative X-Fi ASIO (ただしサンプリングレート192kHzに対応していないので、SqWave2起動後、左の欄で96000Hzにセットしてからデバドラを初期化する必要あり)

以下のASIOデバイスでは正常動作しませんでした。私のバグが原因です。
 * ASIO4ALL …なぜか間欠的に音が鳴る。しかしそもそも、ASIO4ALLって、意味あるのでしょうか。積極的に対応する気になりません
 * Realtek ALC889 …変な音が出ます
 * Prodigy HD2 …音はM-AUDIO並みにちゃんと鳴りますが、やたら不安定です。Foobar2000でも不安定になるのでProdigyのデバドラの問題か？

[ASIO ASIOデバイスについて]

==動作確認OS==
 * Windows XP Professional SP3 32ビット版
 * Windows 7 Professional 64ビット版

= !SqWave2と!WaveGeneの10kHz 矩形波出力波形とスペクトル比較 =

http://bitspersampleconv2.googlecode.com/files/raw.png

↑*図1* 出力データの比較(192kHzサンプリング、矩形波、10kHz、-10dB)

図1は出力データをそのままグラフにプロットしたもので、縦軸がサンプル値、横軸が時間です。
赤い＋点が!SqWave2の出力データ、緑の×点が!WaveGeneの出力データです。
グラフの一番左 0のところは0サンプル目(最初のサンプル値)です。DACのアナログ出力にこの波形が出るわけではないです。(DACの出力波形の綺麗さについては図2で比較できます。)

!WaveGeneの出力である緑の×印をよく見ると、×が連続している個数が、5分の2が9サンプル、5分の3が10サンプルになっています。これは10kHzが192kHzで「割り切れない」ため、矩形波の半波長5個分の時間に、192000分の9秒の半波長を2回、192000分の10秒を3回含むような山谷を繰り返すことで、全体として10kHzの音が出るようにしているのです。これによって、半波長ごとに時間長さが伸び縮みする波形が出てきて、オシロスコープで観察すると不安定な波形が出力されているように見える原因でしょう。

これは図を利用したアバウトな説明で、数学的に厳密な説明ではありません。というのはサンプリング周波数192kHzで9600Hzの矩形波を出力する場合のような、「割り切れる」条件であっても!WaveGeneの矩形波出力には本来の矩形波には含まれない周波数成分が含まれるのです。

!SqWave2の出力である赤色の＋点は、一見乱雑にプロットされているように見えますが、これらすべての点は10kHz矩形波のフーリエ級数をナイキスト周波数近くまで足しこんでできる連続波形の上に乗っているのです。そのため、これを理想的なDACに入力すると、オーバーサンプル処理とLPF処理によって「10kHz矩形波のフーリエ級数をナイキスト周波数近くまで足しこんでできる連続波形」が完全に再現されアナログ音声出力から出てきます。

http://bitspersampleconv2.googlecode.com/files/8x.png

↑*図2* 図1のデータの8倍オーバーサンプリング処理後の出力データの比較

縦軸がサンプル値、横軸が時間です。
出力レベルが小さい赤い線が!SqWave2の出力データ、
出力レベルが大きい緑の線が!WaveGeneの出力データです。
グラフの一番左 0のところは0サンプル目(最初のサンプル値)です。

教科書通りの8倍オーバーサンプリングを行うDACのアナログ出力からは、
大体図2のような波形が出ます。
!SqWave2の出力波形は!WaveGeneよりも安定しています。

最初の半波長ぐらいはどちらも波形が乱れています。この理由は、オーバーサンプリング処理は、
注目サンプル点の前にも後ろにも一定数のサンプル値が必要で、データが送られ始めたばかりの段階では十分なデータが集まらないため補間の精度が低下するためでしょう。

なお、オーバーサンプリングはsndfile-resampleを用いて以下のようにして行いました。
sndfile-resampleは極めて高精度なリサンプルができるのでおすすめです。
{{{
sndfile-resample -by 8 -c 0 SQ10K_192.wav SQ10K_1536.wav
sndfile-resample -by 8 -c 0 WG10K_192.wav WG10K_1536.wav
}}}

http://bitspersampleconv2.googlecode.com/files/spectrum.png

↑*図3* !SqWave2の10kHz 矩形波出力データのスペクトログラム

http://bitspersampleconv2.googlecode.com/files/spectrum_wg.png

↑*図4* !WaveGeneの10kHz 矩形波出力データのスペクトログラム

!WaveGeneの出力データはエイリアシング歪が生じています。
これだけ大きな音量で関係ない周波数成分が含まれていると、耳で聞いてもわかります。

http://bitspersampleconv2.googlecode.com/files/SQ10KOSC.png

↑*図5* !SqWave2 10kHz矩形波 ASIO出力 !ProFire2626のアナログ音声出力波形をオシロスコープで観察

http://bitspersampleconv2.googlecode.com/files/WG10KOSC.png

↑*図6* !WaveGene 10kHz矩形波 ASIO出力 !ProFire2626のアナログ音声出力波形をオシロスコープで観察

半波長ごとに時間長さが変化する複雑な波形のため、うまく同期しません

*「割り切れる」9600Hzの矩形波を192kHzサンプリングで出力した場合の比較 *

http://bitspersampleconv2.googlecode.com/files/9600.png

↑*図7* 出力サンプル値　最初の100サンプルをプロットしたもの

http://bitspersampleconv2.googlecode.com/files/9600x8.png

↑*図8* 出力サンプル値　最初の100サンプルを8倍オーバーサンプルし、実線でつないだもの

http://bitspersampleconv2.googlecode.com/files/9600x8.png

↑*図9* 出力サンプル値　最初の100サンプルを8倍オーバーサンプルし、実線でつないだもの

http://bitspersampleconv2.googlecode.com/files/SQ9600_192.png

↑*図10* !SqWave2の9600Hz 矩形波出力データのスペクトログラム

http://bitspersampleconv2.googlecode.com/files/WG9600_192.png

↑*図11* !WaveGeneの9600Hz 矩形波出力データのスペクトログラム

サンプリング周波数と出力する矩形波の周波数が「割り切れる」周波数比の場合!SqWave2も!WaveGeneも、可聴域に関係ない周波数成分は含まれていません。ただ、高調波成分のレベルが異なります。第5次高調波成分 48000Hzのところにカーソルを合わせて出力レベルを比べました(図10と図11)

  * !SqWave2は第5次高調波が第1次高調波の-14dB
  * !WaveGeneは第5次高調波が第1次高調波の-13dB

矩形波のフーリエ級数の式によると、第5次高調波は、5分の1 = -13.98dB含まれているのが正しい

したがって!SqWave2のほうが正確な出力波形が出ています。

= 開発方法 =

このプログラムは.NET Framework 4を使用して作りました。

Visual Studio 2010が必要です。

TortoiseSVNなどを使って https://bitspersampleconv2.googlecode.com/svn/trunk をチェックアウトします

チェックアウトしてきたツリーにASIO SDKをunzipしたものをコピーして 同じ親ディレクトリのなかにASIOSDK2とAsioIOがある状態にして AsioIO\AsioIODLL\copyasiofiles.batを実行するとASIOSDKの中から asio.cppなど9つのファイルをAsioIO\AsioIODLL\にコピーします

Visual Studio 2010でsqwave2.slnを開いてF5でビルドして実行します 

= 更新履歴 =

=== !SqWave2 バージョン 1.0.9 ===
  * http://bitspersampleconv2.googlecode.com/files/SqWave10009.zip
  * ASIO出力バッファサイズをpreferredからmaxに増やす。
  * 2回目以降のASIOStartで前回の最後の出力が1バッファ分繰り返される問題を修正。
  * M-AUDIO !ProFire 2626のASIO出力が納得のいく出来になった。
  * ASIO4ALLで鳴るかどうかはASIO4ALLの先につながっているオーディオデバイスによるようだ
  * !RealTek ASIOはまだ変な音が鳴る

=== !SqWave2 バージョン 1.0.8 ===
  * http://bitspersampleconv2.googlecode.com/files/SqWave10008.zip
  * ASIO出力対応。

=== !SqWave2 バージョン 1.0.4 ===
  * http://bitspersampleconv2.googlecode.com/files/SqWave10004.zip
  * 級数加算打ち切り周波数をナイキスト周波数との比の％で入力できるようにしました。

=== !SqWave2 バージョン 1.0.2 ===
  * http://bitspersampleconv2.googlecode.com/files/SqWave10002.zip
  * のこぎり波、三角波もでるようにしました。

=== !SqWave2 バージョン 1.0.1 ===
  * http://bitspersampleconv2.googlecode.com/files/SqWave10001.zip
  * ダイアログに入れられた値の範囲チェック。
  * マルチコア対応。Intel Core i7-980Xでの実行結果。見事にすべてのCPUコアに負荷が分散していますｗ (矩形波、10Hz、30秒のWAVファイル生成中の様子)

http://bitspersampleconv2.googlecode.com/files/taskman.png

=== !SqWave2 バージョン 1.0.0 ===
  * http://bitspersampleconv2.googlecode.com/files/SqWave10000.zip
  * 新規作成

=== !SqWave1 バージョン 1.0.0 ===
  * 新規作成。
  * 誤ってプロジェクトファイルを壊してしまったため廃棄

----

ASIO is a trademark of Steinberg Media Technologies GmbH.