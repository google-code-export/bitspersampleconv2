#summary WASAPI排他モードでWAVファイルを再生
#labels Featured

= WASAPI排他モードでWAVファイルを再生 =

!PlayPcmWinはWASAPI排他モードでWAVファイルを再生するプログラムです。

http://bitspersampleconv2.googlecode.com/files/PlayPcmWin112.png

Windows 7に対応しております。Windows XPでは動きません。Vistaは、もしかしたら動くかも。

!PlayPcmWinは実験プログラムです。使いやすいとは言えません。WASAPI排他モードで音楽を聴きたい場合は、Foobar2000のfoo_out_wasapiプラグインを使うのが便利です。

*ビットマッチ出力するために作成したソフトウェアのため、最大音量で出力します。音量の調節機能はありません。CDプレーヤーにボリュームが付いていないのと同じです。音量はプリアンプで絞って下さい。*

=ダウンロード=

  * 32ビット版 http://bitspersampleconv2.googlecode.com/files/PlayPcmWin114.zip
  * 64ビット版 http://bitspersampleconv2.googlecode.com/files/PlayPcmWin114x64.zip

|| Windows  || !PlayPcmWin || 結果 ||
|| 32ビット版 || 32ビット版   || ○ ||
|| 64ビット版 || 64ビット版   || ○ ||
|| 32ビット版 || 64ビット版   || × ||
|| 64ビット版 || 32ビット版   || △ ||

32ビット版のWindowsの場合は32ビット版の!PlayPcmWinを、
64ビット版のWindowsの場合は64ビット版の!PlayPcmWinを使用してください。
32ビット版のWindowsで64ビット版の!PlayPcmWinを動かすことはできません。
64ビット版のWindowsで32ビット版の!PlayPcmWinを実行することは可能ですが、性能や機能が低下するかも。

=使用方法=

zipを展開して、中のSetup.exeを実行してインストールし、
!PlayPcmWinを開き、再生するWAVファイルを指定して、
使用する出力デバイスを選択し、再生ボタンを押します。

アンインストールは、プログラムの追加と削除で行うか、もう一度Setup.exeを実行して削除を選びます。

=RME FF400やM-AUDIO ProFireでWASAPI排他モードを使うときのコツ=

これらのデバイスのドライバは、WASAPI排他モードの出来がいまいちで(作りかけっぽい)
WASAPIからデバイスのマスターサンプリングレートの変更ができません。
タスクトレイの「Fireface Settings」や「M-Audio ProFire」でマスターサンプリングレートを、再生するWAVファイルのサンプリングレートに予め設定してください。

さらに、RME FF400はWASAPI排他モードから量子化ビット数24ビットの再生をすることができません。
ASIOからは出来るのですが……。

=RME FF400で出力レイテンシーを短く設定したい場合=

タスクトレイの「Fireface Settings」を起動し、Fireface(1)タブのBuffer Size(Latency)を小さい値にします。

レイテンシー設定の組み合わせと音切れの有無(44.1kHz 16bit stereo時)

|| Fireface Settings の Buffer Size(Latency) || PlayPcmWinの出力レイテンシー設定 || IAudioClient::GetBufferSize()の戻り値||PCが低負荷状態での音切れ有無 ||
|| 1024 Samples || 13 ミリ秒||573サンプル || 無 ||
|| 1024 Samples || 12 ミリ秒||529サンプル || 有 ||
|| 256 Samples || 13 ミリ秒||573サンプル || 無 ||
|| 256 Samples || 12 ミリ秒||529サンプル || 有 ||
|| 64 Samples || 4 ミリ秒||176サンプル || 無 ||
|| 64 Samples || 3 ミリ秒||132サンプル || 有 ||
|| 48 Samples || 3 ミリ秒||132サンプル || 無 ||
|| 48 Samples || 2 ミリ秒||- || 設定不可 ||

排他モードでデバイスを占有したまま「Fireface Settings」で、この設定をいじくっていると、BSODが発生しますがデバドラの不具合であり私のせいではありません。

出力レイテンシーを短く設定するのは、音切れの可能性が上がるので、おすすめしません。

3ミリ秒の設定では、再生中にエクスプローラーでフォルダーを開くだけで音切れします。音質以前の問題です。

=Creative X-FiTiHDで44.1kHzのイベント駆動再生ができない問題=

Creative X-FiTiHDは、44.1kHzサンプリングでイベント駆動モードが使えません。
タイマー駆動モードにすれば動きます。

理由はわかりません。

=メモリが足りない(OutOfMemory例外が発生する)場合=

64ビット版OSを入れて、メモリを増設して下さい。メモリは安いです。
24GB(4GBを6枚)積んでも5万円です！

=64ビット版Windows上で実行しているプログラムが64ビット版かどうか調べる方法=

タスクバーを右クリックして[タスク マネージャーの起動]を選び、
Windows タスクマネージャーの[プロセス]タブを開いて、イメージ名一覧を見ます。
名前の最後に ＊32と付いているものは
32ビット版のプログラムで、付いていないものは64ビット版のプログラムです。

=ソースコード=

閲覧だけなら:
  * http://code.google.com/p/bitspersampleconv2/source/browse/#svn/trunk/PlayPcmWin
  * http://code.google.com/p/bitspersampleconv2/source/browse/#svn/trunk/WasapiCS
  * http://code.google.com/p/bitspersampleconv2/source/browse/#svn/trunk/WasapiIODLL
  * http://code.google.com/p/bitspersampleconv2/source/browse/#svn/trunk/WavRWLib2

WASAPIの関数を呼び出しているところは、WasapiUser.cppにあります。
http://code.google.com/p/bitspersampleconv2/source/browse/trunk/WasapiIODLL/WasapiUser.cpp


ビルドしたい場合は、Sourceページに行ってソースコードをTortoiseSVNなどでチェックアウトしてきます。
!PlayPcmWin/!PlayPcmWin.slnをVS2010で開いてビルド。

=参考文献=

http://msdn.microsoft.com/en-us/library/dd370844%28v=VS.85%29.aspx

=更新履歴=
===!PlayPcmWin 1.0.14 ==
  * WAVファイルのドラッグアンドドロップに対応。ただし、1ファイルしかドロップできず、ドロップできる場所も変である。

===!PlayPcmWin 1.0.13 ==
  * 再生中の描画負荷を下げた。

===!PlayPcmWin 1.0.12 ==
  * バッファ詰めスレッドの優先度タイプ設定「Pro Audio」が選択できるようになった。

===!PlayPcmWin 1.0.11 ==
  * !PlayPcmWin 1.0.10でイベント駆動モードがバグッたのを修正。
  * 64ビット版を作成。

===!PlayPcmWin 1.0.10 ==
  * 「対応フォーマット」ボタンを押したときにIAudioClient::GetDevicePeriodの値を表示するようにした。

===!PlayPcmWin 1.0.9 ==
  * 従来のイベント駆動モードに加えてタイマー駆動モードを追加。

===!PlayPcmWin 1.0.8 ==
  * インストーラープログラムを修正。

===!PlayPcmWin 1.0.7 ==
  * 量子化ビット数24ビット 2チャンネルのWAVファイルにも対応した。量子化ビット数24ビットでビットマッチ出力しているかどうかについては未調査。
  * デフォルトの出力レイテンシーを100msに設定。
  * 対応フォーマット一覧出力機能。

===!PlayPcmWin 1.0.5 ==
  * バージョン番号の上げ忘れを修正。

===!PlayPcmWin 1.0.4 ==
  * 出力レイテンシーをデフォルトの10ミリ秒以外に設定できるようにした。

===!PlayPcmWin 1.0.3 ==
  * サンプリング周波数等の設定に失敗したあとに、もう一度設定しようとすると異常終了する不具合を修正。

===!PlayPcmWin 1.0.1 ==
  * コンソールプログラムをやめてウィンドウが出るようにした。
  * .NET Framework 4.0 Client profileを使用。

===バージョン1.2 ===
  * ビットマッチ再生

===バージョン1.1===
  * 最終フレームのサイズが中途半端になって失敗する問題を修正。
  * 再生位置の変数をmutexで守るようにした。

===バージョン1.0===

  * 量子化ビット数16ビット、2チャンネル、非圧縮PCMのWAVEファイルに対応。
  * 音は一応鳴るが、最終フレームのバッファ確保のサイズ計算に問題があり、ほとんど必ず最後にエラーメッセージが出て終了します。