#summary WASAPI排他モードでWAVファイルを再生するプログラムPlayPcmWinのページ
#labels Featured

= !PlayPcmWinのページ =

!PlayPcmWinはWASAPI排他モードでWAVファイルを再生するプログラムです。

http://bitspersampleconv2.googlecode.com/files/PlayPcmWin128.jpg

Windows 7に対応しております。Windows XPでは動きません。Vistaは、WASAPI排他モードは動きますが、WASAPI共有モードはWindows7の機能を使用しているためVistaでは動きません。

!PlayPcmWinは実験プログラムです。使いやすいとは言えません。WASAPI排他モードで音楽を聴きたい場合は、Foobar2000のfoo_out_wasapiプラグインを使うのが便利です。


=ダウンロード=

  * 32ビット版 http://bitspersampleconv2.googlecode.com/files/PlayPcmWin130.zip
  * 64ビット版 http://bitspersampleconv2.googlecode.com/files/PlayPcmWin130x64.zip

|| Windows  || !PlayPcmWin || 結果 ||
|| 32ビット版 || 32ビット版   || ○ ||
|| 64ビット版 || 64ビット版   || ○ ||
|| 32ビット版 || 64ビット版   || × ||
|| 64ビット版 || 32ビット版   || △ ||

32ビット版のWindowsの場合は32ビット版の!PlayPcmWinを、
64ビット版のWindowsの場合は64ビット版の!PlayPcmWinを使用してください。
32ビット版のWindowsで64ビット版の!PlayPcmWinを動かすことはできません。
64ビット版のWindowsで32ビット版の!PlayPcmWinを実行することは可能ですが、使用可能なメモリ量が制限されるため、再生リストに貯められるWAVデータ数が減り、実用性が低下します。

=使用方法=

zipを展開して、中のSetup.exeを実行してインストールし、
!PlayPcmWinを開き、再生するWAVファイルを指定して、
使用する出力デバイスを選択し、再生ボタンを押します。

アンインストールは、プログラムの追加と削除で行うか、もう一度Setup.exeを実行して削除を選びます。

=デバイス選択の[選択]ボタンを押すと、[PlayPcmWinは動作を停止しました]が出る問題=

これは!PlayPcmWinのバグで、原因はメモリ不足です。
ご迷惑をおかけしております。

メモリが足りない場合、64ビット版OSを入れて、メモリを増設して下さい。メモリは安いです。

目安としては、
32ビット版Windowsでメモリ3GB、64ビット版Windowsでメモリ4GBぐらいあると、!PlayPcmWinはそこそこ使える状態になります。

32ビット版で、メモリ2GB以下の場合、!PlayPcmWinはCD1枚分のプレイリストも扱えず、
あまり使い勝手がよくないと思います。

=RME FF400やM-AUDIO ProFireでWASAPI排他モードを使うときのコツ=

これらのデバイスのドライバは、WASAPI排他モードの出来がいまいちで(作りかけっぽい)
WASAPIからデバイスのマスターサンプリングレートの変更ができません。
タスクトレイの「Fireface Settings」や「M-Audio ProFire」でマスターサンプリングレートを、再生するWAVファイルのサンプリングレートに予め設定してください。

さらに、RME FF400はWASAPI排他モードから量子化ビット数24ビットの再生をすることができません。
ASIOからは出来るのですが……。

M-AUDIO ProFireはWASAPI排他モードから量子化ビット数24ビットの再生が可能です。

=Creative X-FiTiHDで44.1kHzのイベント駆動再生ができない問題=

Creative X-FiTiHDは、44.1kHzサンプリングでWASAPI排他イベント駆動モードが使えません。
WASAPI排他タイマー駆動モードにすれば動きます。

理由はわかりません。PlayPcmWinのバグの可能性もあります。

=64ビット版Windows上で実行しているプログラムが64ビット版かどうか調べる方法=

タスクバーを右クリック[タスク マネージャーの起動]を選び、
(またはCTRLを押しながらSHIFTを押しながらESCを押して)、
Windows タスクマネージャーの[プロセス]タブを開いて、イメージ名一覧を見ます。
名前の最後に ＊32と付いているものは
32ビット版のプログラムで、付いていないものは64ビット版のプログラムです。

=レンダースレッドタスクタイプ"Audio"と"Pro Audio"の違いに付いて=

これは、
AvSetMmThreadCharacteristics()関数の第1引数です。

この引数の説明はMultimedia Class Scheduler Serviceの解説にあります

http://msdn.microsoft.com/en-us/library/ms684247%28v=VS.85%29.aspx

Pro Audioにすると、出力レイテンシーを10ミリ秒よりも短く設定した場合に
音切れの可能性が減るらしいです。
実際に試すと、あまり効果はありませんでした。

=RME FF400で出力レイテンシーをすごく短く設定したい場合=

WASAPI排他モードを使用します(共有モードでは30ミリ秒よりも短くできません)。
WASAPIイベント駆動モードを使用します(タイマー駆動モードの2倍のイベント間隔になり、
同じレイテンシーでもバッファーサイズを大きくできます)。

タスクトレイの「Fireface Settings」を起動し、Fireface(1)タブのBuffer Size(Latency)を小さい値にします。

レイテンシー設定の組み合わせと音切れの有無(44.1kHz 16bit stereo イベント駆動)

|| Fireface Settings の Buffer Size(Latency) || PlayPcmWinの出力レイテンシー設定 || IAudioClient::GetBufferSize()の戻り値||PCが低負荷状態での音切れ有無 ||
|| 1024 Samples || 13 ミリ秒||573サンプル || 無 ||
|| 1024 Samples || 12 ミリ秒||529サンプル || 有 ||
|| 256 Samples || 13 ミリ秒||573サンプル || 無 ||
|| 256 Samples || 12 ミリ秒||529サンプル || 有 ||
|| 64 Samples || 4 ミリ秒||176サンプル || 無 ||
|| 64 Samples || 3 ミリ秒||132サンプル || 有 ||
|| 48 Samples || 3 ミリ秒||132サンプル || 無 ||
|| - || 2 ミリ秒||- || 設定不可 ||

排他モードでデバイスを占有したまま「Fireface Settings」で、この設定をいじくっていると、BSODが発生しますがデバドラの不具合でありPlayPcmWinの不具合ではありません。

出力レイテンシーを短く設定するのは、音切れの可能性が上がるので、おすすめしません。

3ミリ秒の設定では、再生中にエクスプローラーでフォルダーを開くだけで音切れします。音質以前の問題です。

出力レイテンシーを長く設定すると、再生スレッドのCPU負荷が軽くなります。

=実行中の!PlayPcmWinのバージョン番号を知る方法=

!PlayPcmWinのメニューバーの[ヘルプ][バージョン情報]を選ぶと、バージョン番号が表示されます。

=ソースコード=

閲覧だけなら:
  * http://code.google.com/p/bitspersampleconv2/source/browse/#svn/trunk/PlayPcmWin
  * http://code.google.com/p/bitspersampleconv2/source/browse/#svn/trunk/WasapiCS
  * http://code.google.com/p/bitspersampleconv2/source/browse/#svn/trunk/WasapiIODLL
  * http://code.google.com/p/bitspersampleconv2/source/browse/#svn/trunk/WavRWLib2

WASAPIの関数を呼び出しているところは、WasapiUser.cppにあります。
http://code.google.com/p/bitspersampleconv2/source/browse/trunk/WasapiIODLL/WasapiUser.cpp


ビルドしたい場合は、Sourceページに行ってソースコードをTortoiseSVNなどでチェックアウトしてきます。
!PlayPcmWin/!PlayPcmWin.slnをVS2010で開いてビルド。

=参考文献=

http://msdn.microsoft.com/en-us/library/dd370844%28v=VS.85%29.aspx


=更新履歴=

===!PlayPcmWin 1.0.30 ==
  * バージョン番号表示。

===!PlayPcmWin 1.0.29 ==
  * 再生リストを編集できるステートの判定が、実際よりも緩かったのを修正。

===!PlayPcmWin 1.0.28 ==
  * ステータスバーに使用方法ガイドを表示。
  * 64ビット版の謎のバグを修正し、動作するようになった。

===!PlayPcmWin 1.0.27 ==
  * 32ビット版の、メモリ消費量削減。メモリ消費量がWAVファイルサイズの1倍～2倍ぐらいになった。
  * 1.0.27の64ビット版ビルドは、バグって動作しない

===!PlayPcmWin 1.0.26 ==
  * 32ビット版で、メモリ不足発生時に、メッセージを表示するように修正したつもり。
  * 1.0.26の64ビット版ビルドは、バグって動作しない

===!PlayPcmWin 1.0.24 ==
  * 再生リスト一覧のクリアー時にGarbage Collectするように修正。

===!PlayPcmWin 1.0.23 ==
  * デバイス選択以降にリピートチェックボックスの状態を変更しても反映しない問題を修正。

===!PlayPcmWin 1.0.21 ==
  * 再生リストへのファイルの追加が都合により出来なかった場合のメッセージ表示。

===!PlayPcmWin 1.0.19 ==
  * Windows Media PlayerでリッピングしたWAVEファイルが読み込めない問題を修正。

===!PlayPcmWin 1.0.18 ==
  * 複数ファイルの読み込みと連続再生に対応。

===!PlayPcmWin 1.0.17 ==
  * バージョン番号のあげ忘れを修正。

===!PlayPcmWin 1.0.16 ==
  * 共有モードイベント駆動が、動くようになった。

===!PlayPcmWin 1.0.15 ==
  * 共有モードに対応し始めた。共有モードタイマー駆動は動作する。共有モードイベント駆動はバグっていて動作しない。
  * 共有モードでは、今の作りでは44.1kHzと48kHzしか再生できないようだ。
  * WASAPI排他モード タイマー駆動モードに長らくあった、バッファーオーバーランの不具合を修正。

===!PlayPcmWin 1.0.14 ==
  * WAVファイルのドラッグアンドドロップに対応。ただし、1ファイルしかドロップできず、ドロップできる場所も変である。

===!PlayPcmWin 1.0.13 ==
  * 再生中の描画負荷を下げた。

===!PlayPcmWin 1.0.12 ==
  * バッファ詰めスレッドの優先度タイプ設定「Pro Audio」が選択できるようになった。

===!PlayPcmWin 1.0.11 ==
  * !PlayPcmWin 1.0.10でイベント駆動モードがバグッたのを修正。
  * 64ビット版を作成。

===!PlayPcmWin 1.0.10 ==
  * 「対応フォーマット」ボタンを押したときにIAudioClient::GetDevicePeriodの値を表示するようにした。

===!PlayPcmWin 1.0.9 ==
  * 従来のイベント駆動モードに加えてタイマー駆動モードを追加。

===!PlayPcmWin 1.0.8 ==
  * インストーラープログラムを修正。

===!PlayPcmWin 1.0.7 ==
  * 量子化ビット数24ビット 2チャンネルのWAVファイルにも対応した。量子化ビット数24ビットでビットマッチ出力しているかどうかについては未調査。
  * デフォルトの出力レイテンシーを100msに設定。
  * 対応フォーマット一覧出力機能。

===!PlayPcmWin 1.0.5 ==
  * バージョン番号の上げ忘れを修正。

===!PlayPcmWin 1.0.4 ==
  * 出力レイテンシーをデフォルトの10ミリ秒以外に設定できるようにした。

===!PlayPcmWin 1.0.3 ==
  * サンプリング周波数等の設定に失敗したあとに、もう一度設定しようとすると異常終了する不具合を修正。

===!PlayPcmWin 1.0.1 ==
  * コンソールプログラムをやめてウィンドウが出るようにした。
  * .NET Framework 4.0 Client profileを使用。

===バージョン1.2 ===
  * ビットマッチ再生

===バージョン1.1===
  * 最終フレームのサイズが中途半端になって失敗する問題を修正。
  * 再生位置の変数をmutexで守るようにした。

===バージョン1.0===

  * 量子化ビット数16ビット、2チャンネル、非圧縮PCMのWAVEファイルに対応。
  * 音は一応鳴るが、最終フレームのバッファ確保のサイズ計算に問題があり、ほとんど必ず最後にエラーメッセージが出て終了します。